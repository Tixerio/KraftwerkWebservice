@page "/overview"
@using Microsoft.AspNetCore.SignalR.Client
@using Vizor.ECharts;
@using Color = Vizor.ECharts.Color
@using Label = Vizor.ECharts.Label
@using Tooltip = Vizor.ECharts.Tooltip
@using KraftwerkFrontend.Components.Shared
@using Blazorise.DeepCloner
@rendermode InteractiveServer


<PageTitle>Overview</PageTitle>
<div class="d-flex align-content-center justify-content-center h-100 container">
    <div class="row row-cols-2 h-100 w-100">
        <div class="col"><ConsumptionChart Time="@Time" ConsumptionList="@expectedConsumption"></ConsumptionChart></div>
        <div class="col"><MarketShareChart MarketShares="@marketShares"></MarketShareChart></div>
        <div class="col">Column</div>
        <div class="col">
            <div class="h-100 w-100 d-flex align-content-center justify-content-center">
                <div class="mb-3">
                    <label for="id-input" class="form-label">Kraftwerk ID</label>
                    <InputText class="form-control" id="id-input" @bind-Value="@ID"></InputText>
                </div>
            </div>
        </div>
    </div>

</div>


@code {
    HubConnection hub;
    private double[][] expectedConsumption = new double[24][];
    private Dictionary<string, (string,double)> marketShares = new Dictionary<string, (string,double)>();
    private int Time { get; set; } = 0;
    private string? ID { get; set;}

    public class MarketShare
    {
        public string Name { get; set; }
        public double Value { get; set; }
    }
    
    
    protected override async Task OnInitializedAsync()
    {
        hub = new HubConnectionBuilder()
            .WithUrl("https://localhost:7272/Powergrid")
            .Build();
        await hub.StartAsync();
        await hub.SendAsync("GetExpectedConsume");
        hub.On<Dictionary< int, double>>("ReceiveExpectedConsume", async (message) =>
        {
            double[][] new_list = new double[24][];
            List<double> values = message.Values.ToList();
            for (int i = 0; i < message.Count(); i++)
            {
                new_list[i] = [i, values[i]];
            };
            expectedConsumption = new_list;
            await InvokeAsync(StateHasChanged);
        });
        hub.On<int>("ReceiveTime", async (message) =>
        {
            Time = message;
            await InvokeAsync(StateHasChanged);
        });
        hub.On<Dictionary<string, MarketShare>>("ReceivePieChartData",async (message) =>
        {
            marketShares.Clear();
            message.ToList().ForEach(x =>
            {
                marketShares[x.Key] = (x.Value.Name, x.Value.Value);
            }); await InvokeAsync(StateHasChanged);
        });
    }
    
}